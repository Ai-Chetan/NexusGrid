document.addEventListener('DOMContentLoaded',function(){const elements={timeFilter:document.getElementById('timeFilter'),customDateRange:document.querySelector('.custom-date-range'),searchInput:document.getElementById('searchInput'),searchButton:document.getElementById('searchButton'),statusFilter:document.getElementById('statusFilter'),sortBy:document.getElementById('sortBy'),applyFilters:document.getElementById('applyFilters'),resetFilters:document.getElementById('resetFilters'),startDate:document.getElementById('startDate'),endDate:document.getElementById('endDate'),requestsContainer:document.getElementById('requestsContainer'),noResultsMessage:document.getElementById('noResultsMessage'),resultsCount:document.getElementById('resultsCount'),submitRequestBtn:document.getElementById('submitRequest'),newRequestForm:document.getElementById('newRequestForm'),systemNameInput:document.getElementById('systemName'),labLocationInput:document.getElementById('labLocation'),resourceNameInput:document.getElementById('resourceName'),resourceDescriptionInput:document.getElementById('resourceDescription'),systemSuggestions:document.getElementById('systemSuggestions'),labSuggestions:document.getElementById('labSuggestions')};if(elements.timeFilter&&elements.customDateRange){elements.timeFilter.addEventListener('change',function(){elements.customDateRange.style.display=this.value==='custom'?'flex':'none';});}
if(elements.searchButton&&elements.searchInput){elements.searchButton.addEventListener('click',performSearch);elements.searchInput.addEventListener('keyup',function(event){if(event.key==='Enter')performSearch();});}
if(elements.applyFilters)elements.applyFilters.addEventListener('click',applyFiltersFunc);if(elements.resetFilters)elements.resetFilters.addEventListener('click',resetFiltersFunc);function applyFiltersFunc(){const params=new URLSearchParams();if(elements.searchInput.value.trim())params.set('search',elements.searchInput.value.trim());if(elements.statusFilter.value!=='all')params.set('status',elements.statusFilter.value);if(elements.timeFilter.value!=='all')params.set('time',elements.timeFilter.value);if(elements.sortBy.value!=='newest')params.set('sort',elements.sortBy.value);if(elements.timeFilter.value==='custom'){if(elements.startDate.value)params.set('start',elements.startDate.value);if(elements.endDate.value)params.set('end',elements.endDate.value);}
window.location.search=params.toString();}
function resetFiltersFunc(){window.location.search='';}
function performSearch(){applyFiltersFunc();}
let searchTimeout;function setupAutocomplete(input,suggestionsContainer,endpoint){input.addEventListener('input',function(){clearTimeout(searchTimeout);const query=this.value.trim();if(query.length<2){suggestionsContainer.innerHTML='';return;}
searchTimeout=setTimeout(()=>{fetch(`${endpoint}?q=${encodeURIComponent(query)}`).then(response=>response.json()).then(data=>{displaySuggestions(suggestionsContainer,data.results,input);}).catch(error=>console.error('Error:',error));},300);});}
function displaySuggestions(container,suggestions,input){container.innerHTML=suggestions.map(item=>`<div class="suggestion-item" data-value="${item.name}" data-lab="${item.lab || ''}">
                ${item.display || item.name}
            </div>`).join('');container.querySelectorAll('.suggestion-item').forEach(item=>{item.addEventListener('click',function(){input.value=this.dataset.value;if(this.dataset.lab&&input.id==='systemName'){elements.labLocationInput.value=this.dataset.lab;}
container.innerHTML='';});});}
setupAutocomplete(elements.systemNameInput,elements.systemSuggestions,'/resources/systems-autocomplete/');setupAutocomplete(elements.labLocationInput,elements.labSuggestions,'/resources/labs-autocomplete/');document.addEventListener('click',function(e){if(!e.target.closest('.suggestions-dropdown')&&!e.target.matches('input')){elements.systemSuggestions.innerHTML='';elements.labSuggestions.innerHTML='';}});if(elements.submitRequestBtn){elements.submitRequestBtn.addEventListener('click',function(){if(!elements.newRequestForm.checkValidity()){elements.newRequestForm.reportValidity();return;}
const systemName=elements.systemNameInput.value.trim();const labLocation=elements.labLocationInput.value.trim();const resourceName=elements.resourceNameInput.value.trim();const description=elements.resourceDescriptionInput.value.trim();fetch('/resources/create/',{method:'POST',headers:{'X-CSRFToken':getCookie('csrftoken'),'Content-Type':'application/json'},body:JSON.stringify({system_name:systemName,lab_location:labLocation,resource_name:resourceName,description:description})}).then(res=>res.json()).then(data=>{if(data.success){showAlert('success','Success: Request created!');elements.newRequestForm.reset();bootstrap.Modal.getInstance(document.getElementById('newRequestModal')).hide();setTimeout(()=>location.reload(),1000);}else{showAlert('danger',data.message||'Error: Failed to submit request.');}});});}
function getCookie(name){let cookieValue=null;if(document.cookie&&document.cookie!==''){const cookies=document.cookie.split(';');for(let i=0;i<cookies.length;i++){const cookie=cookies[i].trim();if(cookie.substring(0,name.length+1)===(name+'=')){cookieValue=decodeURIComponent(cookie.substring(name.length+1));break;}}}
return cookieValue;}
function showAlert(type,message){const alertDiv=document.createElement('div');alertDiv.className=`alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;alertDiv.style.zIndex='9999';alertDiv.innerHTML=`
            <strong>${type === 'success' ? 'Success!' : 'Error!'}</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;document.body.appendChild(alertDiv);setTimeout(()=>{alertDiv.classList.remove('show');setTimeout(()=>alertDiv.remove(),150);},3000);}
document.querySelectorAll('form[action*="update-resource-status"]').forEach(form=>{form.addEventListener('submit',function(e){const status=form.querySelector('select[name="status"]').value;if(status==='Fulfilled'){e.preventDefault();const modalEl=document.getElementById('provisionSummaryModal');const modal=new bootstrap.Modal(modalEl);document.getElementById('provisionSummary').value='';const summaryForm=document.getElementById('provisionSummaryForm');summaryForm.onsubmit=function(ev){ev.preventDefault();const summary=document.getElementById('provisionSummary').value.trim();if(!summary){document.getElementById('provisionSummary').focus();return;}
let input=form.querySelector('input[name="provision_summary"]');if(!input){input=document.createElement('input');input.type='hidden';input.name='provision_summary';form.appendChild(input);}
input.value=summary;modal.hide();setTimeout(()=>form.submit(),200);};modal.show();}});});});;