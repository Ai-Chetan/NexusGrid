document.addEventListener('DOMContentLoaded',function(){const elements={timeFilter:document.getElementById('timeFilter'),customDateRange:document.querySelector('.custom-date-range'),searchInput:document.getElementById('searchInput'),searchButton:document.getElementById('searchButton'),faultCards:document.querySelectorAll('.fault-card'),noResultsMessage:document.getElementById('noResultsMessage'),resultsCount:document.getElementById('resultsCount'),statusFilter:document.getElementById('statusFilter'),applyFiltersButton:document.getElementById('applyFilters'),resetFiltersButton:document.getElementById('resetFilters'),startDateInput:document.getElementById('startDate'),endDateInput:document.getElementById('endDate'),sortBySelect:document.getElementById('sortBy'),submitFaultButton:document.getElementById('submitFault'),newFaultForm:document.getElementById('newFaultForm'),systemNameInput:document.getElementById('systemName'),labLocationInput:document.getElementById('labLocation'),systemSuggestions:document.getElementById('systemSuggestions'),labSuggestions:document.getElementById('labSuggestions')};const userRole=document.body.getAttribute("data-user-role")?.trim();if(userRole){document.querySelectorAll("[data-role]").forEach(el=>{el.style.display=(el.getAttribute("data-role")===userRole)?(el.closest(".sidebar")?"flex":"block"):"none";});}
elements.timeFilter.addEventListener('change',function(){elements.customDateRange.style.display=this.value==='custom'?'flex':'none';});elements.searchButton.addEventListener('click',performSearch);elements.searchInput.addEventListener('keyup',function(event){if(event.key==='Enter')performSearch();});function resetFilters(){window.location.search='';}
elements.applyFiltersButton.addEventListener('click',applyFilters);elements.resetFiltersButton.addEventListener('click',resetFilters);let searchTimeout;function setupAutocomplete(input,suggestionsContainer,endpoint){input.addEventListener('input',function(){clearTimeout(searchTimeout);const query=this.value.trim();if(query.length<2){suggestionsContainer.innerHTML='';return;}
searchTimeout=setTimeout(()=>{fetch(`${endpoint}?q=${encodeURIComponent(query)}`).then(response=>response.json()).then(data=>{displaySuggestions(suggestionsContainer,data.results,input);}).catch(error=>console.error('Error:',error));},300);});}
function displaySuggestions(container,suggestions,input){container.innerHTML=suggestions.map(item=>`<div class="suggestion-item" data-value="${item.name}" data-lab="${item.lab || ''}">
                ${item.display || item.name}
            </div>`).join('');container.querySelectorAll('.suggestion-item').forEach(item=>{item.addEventListener('click',function(){input.value=this.dataset.value;if(this.dataset.lab&&input.id==='systemName'){elements.labLocationInput.value=this.dataset.lab;}
container.innerHTML='';validateInput(input);});});}
function validateInput(input){const errorElement=document.getElementById(input.id+'Error');input.classList.remove('is-invalid');errorElement.textContent='';}
function buildQueryParams(){const params=new URLSearchParams();if(elements.searchInput.value.trim())params.set('search',elements.searchInput.value.trim());if(elements.statusFilter.value!=='all')params.set('status',elements.statusFilter.value);if(elements.timeFilter.value!=='all')params.set('time',elements.timeFilter.value);if(elements.sortBySelect.value!=='newest')params.set('sort',elements.sortBySelect.value);if(elements.timeFilter.value==='custom'){if(elements.startDateInput.value)params.set('start',elements.startDateInput.value);if(elements.endDateInput.value)params.set('end',elements.endDateInput.value);}
return params.toString();}
function applyFilters(){const query=buildQueryParams();window.location.search=query;}
function performSearch(){applyFilters();}
setupAutocomplete(elements.systemNameInput,elements.systemSuggestions,'/faults/systems-autocomplete/');setupAutocomplete(elements.labLocationInput,elements.labSuggestions,'/faults/labs-autocomplete/');document.addEventListener('click',function(e){if(!e.target.closest('.suggestions-dropdown')&&!e.target.matches('input')){elements.systemSuggestions.innerHTML='';elements.labSuggestions.innerHTML='';}});elements.submitFaultButton.addEventListener('click',function(){if(!elements.newFaultForm.checkValidity()){elements.newFaultForm.reportValidity();return;}
const formData=new FormData();formData.append('csrfmiddlewaretoken',document.querySelector('[name=csrfmiddlewaretoken]').value);formData.append('system_name',elements.systemNameInput.value);formData.append('lab_location',elements.labLocationInput.value);formData.append('fault_type',document.getElementById('faultType').value);formData.append('description',document.getElementById('faultDescription').value);fetch('/faults/create/',{method:'POST',body:formData}).then(response=>response.json()).then(data=>{if(data.success){showAlert('success',data.message);elements.newFaultForm.reset();bootstrap.Modal.getInstance(document.getElementById('newFaultModal')).hide();setTimeout(()=>location.reload(),1000);}else{showAlert('danger',data.message);}}).catch(error=>{console.error('Error:',error);showAlert('danger','An error occurred while submitting the fault report');});});document.querySelectorAll('.status-form').forEach(form=>{form.addEventListener('submit',function(e){const select=form.querySelector('.status-selector');if(select.value==='resolved'){e.preventDefault();const faultId=form.closest('.fault-card').dataset.faultId;document.getElementById('resolvedFaultId').value=faultId;document.getElementById('resolutionSummary').value='';const modal=new bootstrap.Modal(document.getElementById('resolutionModal'));modal.show();window._pendingResolveForm=form;}});});document.getElementById('resolutionForm').addEventListener('submit',function(e){e.preventDefault();const faultId=document.getElementById('resolvedFaultId').value;const summary=document.getElementById('resolutionSummary').value;const csrfToken=document.querySelector('[name=csrfmiddlewaretoken]').value;fetch(`/faults/update_status/${faultId}/`,{method:'POST',headers:{'X-CSRFToken':csrfToken,'X-Requested-With':'XMLHttpRequest'},body:new URLSearchParams({status:'resolved'})}).then(response=>response.json()).then(data=>{if(data.success){return fetch(`/faults/resolve/${faultId}/`,{method:'POST',headers:{'X-CSRFToken':csrfToken,'Content-Type':'application/json'},body:JSON.stringify({resolution_summary:summary})});}else{throw new Error(data.message||'Failed to update status.');}}).then(response=>response.json()).then(data=>{if(data.success){showAlert('success',data.message);bootstrap.Modal.getInstance(document.getElementById('resolutionModal')).hide();setTimeout(()=>location.reload(),1000);}else{showAlert('danger',data.message);}}).catch(error=>{showAlert('danger',error.message||'Failed to submit resolution.');});});function showAlert(type,message){const alertDiv=document.createElement('div');alertDiv.className=`alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;alertDiv.style.zIndex='9999';alertDiv.innerHTML=`
            <strong>${type === 'success' ? 'Success!' : 'Error!'}</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;document.body.appendChild(alertDiv);setTimeout(()=>{alertDiv.classList.remove('show');setTimeout(()=>alertDiv.remove(),150);},3000);}
const tooltipTriggerList=[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));tooltipTriggerList.map(tooltipTriggerEl=>new bootstrap.Tooltip(tooltipTriggerEl));});;